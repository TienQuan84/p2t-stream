<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phone-to-OBS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; display: flex; flex-direction: column; align-items: center; height: 100vh; font-family: sans-serif; }
        /* Preview nằm ở Top, kích thước 50% */
        #preview { width: 50%; height: auto; aspect-ratio: 16/9; object-fit: contain; background: #222; border-bottom: 2px solid #444; align-self: flex-start; align-items: center;}
        #info { margin-top: 30px; color: white; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; width: 80%; }
        #status-dot { display: inline-block; width: 10px; height: 10px; background: red; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

    <video id="preview" autoplay playsinline muted></video>
    
    <div id="info">
        <div id="status-text"><span id="status-dot"></span> Đang kết nối...</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('join');
        const videoPreview = document.getElementById('preview');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');

        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { 
                        urls: 'turn:openrelay.metered.ca:443', 
                        username: 'openrelayproject', 
                        credential: 'openrelayproject' 
                    }
                ]
            }
        });

        peer.on('open', (id) => {
            if (!targetId) {
                statusText.innerText = "LỖI: Thiếu ID OBS!";
                return;
            }

            // Gọi ngay sau khi mở Peer
            startStreaming();
        });

        async function startStreaming() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 } // Để 30fps cho ổn định khi chạy 4G
                    },
                    audio: true
                });

                videoPreview.srcObject = stream;
                
                // Bắt đầu gọi cho OBS
                const call = peer.call(targetId, stream);
                
                if (call) {
                    statusText.innerText = "ĐANG GỬI TÍN HIỆU...";
                    statusDot.style.background = "orange";

                    call.on('stream', () => {
                        statusText.innerText = "TRỰC TIẾP: ĐÃ KẾT NỐI OBS";
                        statusDot.style.background = "#00ff00";
                    });
                }

            } catch (err) {
                statusText.innerText = "LỖI: Không mở được Camera!";
                console.error(err);
            }
        }

        peer.on('error', (err) => {
            statusText.innerText = "Lỗi Peer: " + err.type;
        });
    </script>
</body>
</html>

