<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phone Sender Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #000; color: white; margin: 0; overflow: hidden; }
        #preview { width: 100%; height: 60vh; object-fit: cover; background: #111; }
        
        .indicator-container { padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* Chấm trạng thái */
        #status-btn { 
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: #ff4444; /* Mặc định Đỏ */
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            transition: 0.5s; margin: 10px auto;
        }
        
        /* Class khi hoạt động (Xanh) */
        .status-active { 
            background: #00ff44 !important; 
            box-shadow: 0 0 25px rgba(0, 255, 68, 0.8) !important;
        }
        
        #msg { font-weight: bold; margin-top: 10px; font-size: 18px; }
        .info { font-size: 14px; color: #aaa; }
    </style>
</head>
<body>
    <video id="preview" autoplay playsinline muted></video>
    
    <div class="indicator-container">
        <div id="status-btn"></div>
        <div id="msg">ĐANG CHỜ KẾT NỐI...</div>
        <div class="info">Trạng thái: <span id="peer-status">Khởi tạo...</span></div>
    </div>

    <script>
        const statusBtn = document.getElementById('status-btn');
        const msg = document.getElementById('msg');
        const peerStatus = document.getElementById('peer-status');
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('join');

        const peer = new Peer();

        peer.on('open', async (id) => {
            peerStatus.innerText = "Sẵn sàng (ID: " + id + ")";
            
            if (!targetId) {
                msg.innerText = "LỖI: THIẾU ID NHẬN";
                return;
            }

            try {
                // Lấy stream từ camera
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: "environment" }, 
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: true
                });

                document.getElementById('preview').srcObject = stream;

                // Thực hiện cuộc gọi đến OBS
                const call = peer.call(targetId, stream);

                if (call) {
                    // Khi OBS nhận được stream và bắt đầu phản hồi (WebRTC Handshake thành công)
                    call.on('stream', () => {
                        statusBtn.classList.add('status-active');
                        msg.innerText = "LIVE: ĐANG TRUYỀN ĐẾN OBS";
                    });

                    // Xử lý khi kết nối bị ngắt
                    call.on('close', () => {
                        statusBtn.classList.remove('status-active');
                        msg.innerText = "ĐÃ NGẮT KẾT NỐI";
                    });
                    
                    // Backup: Nếu PeerJS không kích hoạt sự kiện stream kịp, 
                    // ta vẫn hiện xanh sau 1s nếu call object tồn tại
                    setTimeout(() => {
                        if(call.open) {
                            statusBtn.classList.add('status-active');
                            msg.innerText = "LIVE: ĐANG TRUYỀN ĐẾN OBS";
                        }
                    }, 1500);
                }

            } catch (err) {
                console.error(err);
                msg.innerText = "LỖI CAMERA: " + err.message;
            }
        });

        // Xử lý lỗi kết nối chung
        peer.on('error', (err) => {
            statusBtn.classList.remove('status-active');
            msg.innerText = "LỖI KẾT NỐI";
            console.error(err);
        });
    </script>
</body>
</html>
