<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phone Sender Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #000; color: white; margin: 0; overflow: hidden; }
        #preview { width: 50%; height: 60vh; object-fit: cover; background: #111; }
        .indicator-container { padding: 20px; }
        #status-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: none;
            background: #ff4444; /* Mặc định Đỏ */
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            transition: 0.3s; margin: 10px auto;
        }
        .status-active { 
            background: #00ff44 !important; /* Xanh khi có kết nối */
            box-shadow: 0 0 25px rgba(0, 255, 68, 0.8) !important;
        }
        .info { font-size: 14px; color: #aaa; margin-top: 10px; }
    </style>
</head>
<body>
    <video id="preview" autoplay playsinline muted></video>
    
   

    <script>
        const peer = new Peer();
        const statusBtn = document.getElementById('status-btn');
        const msg = document.getElementById('msg');
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('join');

        peer.on('open', async (id) => {
            if (!targetId) {
                msg.innerText = "LỖI: THIẾU ID NHẬN";
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { exact: "environment" }, // BẮT BUỘC CAMERA SAU
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: true
                });

                document.getElementById('preview').srcObject = stream;
                const call = peer.call(targetId, stream);

                // Khi bắt đầu gọi thành công
                call.on('stream', () => {
                    statusBtn.classList.add('status-active');
                    msg.innerText = "ĐANG TRUYỀN (LIVE)";
                });

                // Xử lý khi kết nối bị đóng
                call.on('close', () => {
                    statusBtn.classList.remove('status-active');
                    msg.innerText = "ĐÃ NGẮT KẾT NỐI";
                });

                // Dự phòng cho PeerJS: nếu call được tạo, tạm thời hiện xanh
                if(call) {
                    statusBtn.classList.add('status-active');
                    msg.innerText = "ĐANG TRUYỀN (LIVE)";
                }

            } catch (err) {
                console.error(err);
                msg.innerText = "LỖI CAMERA SAU: " + err.message;
                // Nếu không có camera sau (exact), thử lại với mode environment thường
                if (err.name === "OverconstrainedError" || err.name === "NotFoundError") {
                    alert("Không tìm thấy Camera sau chuyên dụng, đang thử chế độ mặc định.");
                    location.href = location.href.replace('exact:', '');
                }
            }
        });
    </script>
</body>
</html>


